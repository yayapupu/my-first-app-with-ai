<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>å™—å™— Binance äº‹ä»¶åˆç´„é æ¸¬å™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f9fa; text-align: center; padding: 20px; }
    h1 { color: #222; }
    #result { font-size: 1.5em; margin-top: 20px; }
    .btn-group { margin-top: 10px; }
    button { margin: 5px; padding: 8px 12px; font-size: 16px; cursor: pointer; }
    iframe { margin-top: 30px; border: none; }
  </style>
</head>
<body>
  <h1>å™—å™— Binance äº‹ä»¶åˆç´„é æ¸¬å™¨</h1>
  <p>ä»¥ MACD æŠ€è¡“æŒ‡æ¨™é æ¸¬ BTC/ETH æœªä¾†èµ°å‹¢</p>

  <div class="btn-group">
    <button onclick="analyze('BTCUSDT', '1m')">åˆ†æ BTCï¼ˆ10åˆ†é˜ï¼‰</button>
    <button onclick="analyze('ETHUSDT', '1m')">åˆ†æ ETHï¼ˆ10åˆ†é˜ï¼‰</button>
    <button onclick="analyze('BTCUSDT', '30m')">åˆ†æ BTCï¼ˆ30åˆ†é˜ï¼‰</button>
    <button onclick="analyze('ETHUSDT', '30m')">åˆ†æ ETHï¼ˆ30åˆ†é˜ï¼‰</button>
  </div>

  <div id="result">è«‹é¸æ“‡è¦é æ¸¬çš„å¹£ç¨®èˆ‡æ™‚é–“ç´šåˆ¥</div>

  <div id="tv-widget">
    <iframe id="tv-iframe"
      width="100%"
      height="500"
      src=""
      allowtransparency="true"
      scrolling="no">
    </iframe>
  </div>

  <script>
    async function getKlines(symbol, interval = '1m', limit = 100) {
      const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`);
      const data = await res.json();
      return data.map(d => ({
        time: d[0],
        close: parseFloat(d[4])
      }));
    }

    function ema(prices, period) {
      const k = 2 / (period + 1);
      let emaArray = [prices[0]];
      for (let i = 1; i < prices.length; i++) {
        emaArray.push(prices[i] * k + emaArray[i - 1] * (1 - k));
      }
      return emaArray;
    }

    function getMACD(prices) {
      const ema12 = ema(prices, 12);
      const ema26 = ema(prices, 26);
      const dif = ema12.map((v, i) => v - ema26[i]);
      const dea = ema(dif, 9);
      const macd = dif.map((v, i) => v - dea[i]);
      return { dif, dea, macd };
    }

    async function analyze(symbol, interval) {
      const data = await getKlines(symbol, interval);
      const closes = data.map(d => d.close);
      const { dif, dea } = getMACD(closes);

      const len = dif.length;
      const prevDIF = dif[len - 2];
      const prevDEA = dea[len - 2];
      const currDIF = dif[len - 1];
      const currDEA = dea[len - 1];

      let resultText = '';
      const intervalName = interval === '1m' ? '10åˆ†é˜ç´šåˆ¥' : '30åˆ†é˜ç´šåˆ¥';

      if (prevDIF < prevDEA && currDIF > currDEA) {
        resultText = `${symbol}ï¼ˆ${intervalName}ï¼‰: çœ‹æ¼² ğŸ“ˆï¼ˆé»ƒé‡‘äº¤å‰ï¼‰`;
      } else if (prevDIF > prevDEA && currDIF < currDEA) {
        resultText = `${symbol}ï¼ˆ${intervalName}ï¼‰: çœ‹è·Œ ğŸ“‰ï¼ˆæ­»äº¡äº¤å‰ï¼‰`;
      } else {
        resultText = `${symbol}ï¼ˆ${intervalName}ï¼‰: ç›¤æ•´ä¸­ï¼Œä¸å®œå…¥å ´ ğŸš«`;
      }

      document.getElementById('result').innerText = resultText;

      // æ›´æ–° TradingView åœ–è¡¨
      const tvSymbol = symbol.replace('USDT', 'USD').toLowerCase(); // e.g. btcusd
      const iframeUrl = `https://s.tradingview.com/widgetembed/?symbol=BINANCE:${symbol}&interval=${interval === '1m' ? 1 : 30}&theme=light&style=1&locale=zh_TW&hide_top_toolbar=true`;
      document.getElementById('tv-iframe').src = iframeUrl;
    }
  </script>
</body>
</html>
