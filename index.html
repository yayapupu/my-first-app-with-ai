<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>å™—å™— Binance äº‹ä»¶åˆç´„é æ¸¬å™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f9fa; text-align: center; padding: 20px; }
    h1 { color: #222; }
    #result { font-size: 1.2em; margin-top: 20px; white-space: pre-line; text-align: left; display: inline-block; }
    .btn-group { margin-top: 10px; }
    button { margin: 5px; padding: 8px 12px; font-size: 16px; cursor: pointer; }
    iframe { margin-top: 30px; border: none; }
    #timestamp { font-size: 0.9em; color: #666; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>å™—å™— Binance äº‹ä»¶åˆç´„é æ¸¬å™¨</h1>
  <p>ä»¥ MACD + RSI + KDJ + å¸ƒæ—é€šé“å¤šæŒ‡æ¨™é æ¸¬ BTC/ETH æœªä¾†èµ°å‹¢</p>

  <div class="btn-group">
    <button onclick="analyze('BTCUSDT', '1m')">åˆ†æ BTCï¼ˆ10åˆ†é˜ï¼‰</button>
    <button onclick="analyze('ETHUSDT', '1m')">åˆ†æ ETHï¼ˆ10åˆ†é˜ï¼‰</button>
    <button onclick="analyze('BTCUSDT', '30m')">åˆ†æ BTCï¼ˆ30åˆ†é˜ï¼‰</button>
    <button onclick="analyze('ETHUSDT', '30m')">åˆ†æ ETHï¼ˆ30åˆ†é˜ï¼‰</button>
  </div>

  <div id="result">è«‹é¸æ“‡è¦é æ¸¬çš„å¹£ç¨®èˆ‡æ™‚é–“ç´šåˆ¥</div>
  <div id="timestamp"></div>

  <div id="tv-widget">
    <iframe id="tv-iframe"
      width="100%"
      height="500"
      src=""
      allowtransparency="true"
      scrolling="no">
    </iframe>
  </div>

  <script>
    async function getKlines(symbol, interval = '1m', limit = 100) {
      const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`);
      const data = await res.json();
      return data.map(d => ({
        time: d[0],
        close: parseFloat(d[4]),
        high: parseFloat(d[2]),
        low: parseFloat(d[3])
      }));
    }

    function ema(prices, period) {
      const k = 2 / (period + 1);
      let emaArray = [prices[0]];
      for (let i = 1; i < prices.length; i++) {
        emaArray.push(prices[i] * k + emaArray[i - 1] * (1 - k));
      }
      return emaArray;
    }

    function getMACD(prices) {
      const ema12 = ema(prices, 12);
      const ema26 = ema(prices, 26);
      const dif = ema12.map((v, i) => v - ema26[i]);
      const dea = ema(dif, 9);
      return { dif, dea, macd: dif.map((v, i) => v - dea[i]) };
    }

    function getRSI(prices, period = 14) {
      let gains = [], losses = [];
      for (let i = 1; i < prices.length; i++) {
        const diff = prices[i] - prices[i - 1];
        if (diff >= 0) gains.push(diff), losses.push(0);
        else gains.push(0), losses.push(-diff);
      }
      let avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
      let avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;
      for (let i = period; i < gains.length; i++) {
        avgGain = (avgGain * (period - 1) + gains[i]) / period;
        avgLoss = (avgLoss * (period - 1) + losses[i]) / period;
      }
      const rs = avgGain / avgLoss;
      return 100 - (100 / (1 + rs));
    }

    function getKDJ(data, period = 9) {
      let RSV = [];
      for (let i = period - 1; i < data.length; i++) {
        const window = data.slice(i - period + 1, i + 1);
        const high = Math.max(...window.map(d => d.high));
        const low = Math.min(...window.map(d => d.low));
        const close = data[i].close;
        RSV.push(((close - low) / (high - low)) * 100);
      }

      let K = [50], D = [50];
      for (let i = 0; i < RSV.length; i++) {
        const prevK = K[i] || 50;
        const prevD = D[i] || 50;
        K.push((2 / 3) * prevK + (1 / 3) * RSV[i]);
        D.push((2 / 3) * prevD + (1 / 3) * K[i + 1]);
      }
      return { K: K.slice(-2), D: D.slice(-2) };
    }

    function getBollingerBands(prices, period = 20) {
      const slice = prices.slice(-period);
      const avg = slice.reduce((a, b) => a + b, 0) / period;
      const stdDev = Math.sqrt(slice.map(p => Math.pow(p - avg, 2)).reduce((a, b) => a + b) / period);
      return {
        upper: avg + (2 * stdDev),
        lower: avg - (2 * stdDev),
        mid: avg,
        lastPrice: prices[prices.length - 1]
      };
    }

    function getNowTimeStr() {
      const now = new Date();
      return now.toLocaleString("zh-TW", { hour12: false });
    }

    async function analyze(symbol, interval) {
      const data = await getKlines(symbol, interval);
      const closes = data.map(d => d.close);

      // MACD
      const { dif, dea } = getMACD(closes);
      const len = dif.length;
      const prevDIF = dif[len - 2], prevDEA = dea[len - 2];
      const currDIF = dif[len - 1], currDEA = dea[len - 1];
      const macdSignal = (prevDIF < prevDEA && currDIF > currDEA) ? 'çœ‹æ¼²'
                         : (prevDIF > prevDEA && currDIF < currDEA) ? 'çœ‹è·Œ' : 'ç›¤æ•´';

      // RSI
      const rsi = getRSI(closes).toFixed(2);
      const rsiSignal = rsi > 70 ? 'è¶…è²·ï¼Œçœ‹è·Œ' : rsi < 30 ? 'è¶…è³£ï¼Œçœ‹æ¼²' : 'ä¸­æ€§';

      // KDJ
      const kdj = getKDJ(data);
      const kCrossUp = kdj.K[0] < kdj.D[0] && kdj.K[1] > kdj.D[1];
      const kCrossDown = kdj.K[0] > kdj.D[0] && kdj.K[1] < kdj.D[1];
      const kdjSignal = kCrossUp ? 'é»ƒé‡‘äº¤å‰ï¼Œçœ‹æ¼²' : kCrossDown ? 'æ­»äº¡äº¤å‰ï¼Œçœ‹è·Œ' : 'ç„¡äº¤å‰ï¼Œç›¤æ•´';

      // å¸ƒæ—é€šé“
      const bb = getBollingerBands(closes);
      const bollSignal = bb.lastPrice > bb.upper ? 'çªç ´ä¸Šè»Œï¼Œçœ‹æ¼²'
                          : bb.lastPrice < bb.lower ? 'è·Œç ´ä¸‹è»Œï¼Œçœ‹è·Œ'
                          : 'å€é–“å…§ï¼Œç›¤æ•´';

      // çµ±æ•´çµè«–
      let signals = [macdSignal, rsiSignal.includes('çœ‹æ¼²') ? 'çœ‹æ¼²' : rsiSignal.includes('çœ‹è·Œ') ? 'çœ‹è·Œ' : 'ç›¤æ•´',
                     kdjSignal.includes('çœ‹æ¼²') ? 'çœ‹æ¼²' : kdjSignal.includes('çœ‹è·Œ') ? 'çœ‹è·Œ' : 'ç›¤æ•´',
                     bollSignal.includes('çœ‹æ¼²') ? 'çœ‹æ¼²' : bollSignal.includes('çœ‹è·Œ') ? 'çœ‹è·Œ' : 'ç›¤æ•´'];

      const counts = signals.reduce((acc, val) => { acc[val] = (acc[val] || 0) + 1; return acc; }, {});
      let final = (counts['çœ‹æ¼²'] >= 3) ? 'ğŸ“ˆ çœ‹æ¼²æ©Ÿç‡é«˜ï¼Œå»ºè­°å¤šå–®é€²å ´'
               : (counts['çœ‹è·Œ'] >= 3) ? 'ğŸ“‰ çœ‹è·Œæ©Ÿç‡é«˜ï¼Œå»ºè­°ç©ºå–®é€²å ´'
               : 'ğŸš« ç›¤æ•´ä¸­ï¼Œä¸å®œé€²å ´';

      const intervalName = interval === '1m' ? '10åˆ†é˜ç´šåˆ¥' : '30åˆ†é˜ç´šåˆ¥';

      document.getElementById('result').innerText =
`${symbol}ï¼ˆ${intervalName}ï¼‰ æŠ€è¡“åˆ†æçµæœï¼š

ğŸ§  MACDï¼š${macdSignal}
ğŸ“ RSIï¼š${rsi}ï¼ˆ${rsiSignal}ï¼‰
ğŸ“‰ KDJï¼šK=${kdj.K[1].toFixed(2)}, D=${kdj.D[1].toFixed(2)}ï¼ˆ${kdjSignal}ï¼‰
ğŸ“Š å¸ƒæ—é€šé“ï¼šUpper=${bb.upper.toFixed(2)} / Lower=${bb.lower.toFixed(2)} / åƒ¹æ ¼=${bb.lastPrice.toFixed(2)}ï¼ˆ${bollSignal}ï¼‰

âœ… ç¶œåˆçµè«–ï¼š${final}`;

      document.getElementById('timestamp').innerText = `åˆ†ææ™‚é–“ï¼š${getNowTimeStr()}`;
      const iframeUrl = `https://s.tradingview.com/widgetembed/?symbol=BINANCE:${symbol}&interval=${interval === '1m' ? 1 : 30}&theme=light&style=1&locale=zh_TW&hide_top_toolbar=true`;
      document.getElementById('tv-iframe').src = iframeUrl;
    }
  </script>
</body>
</html>
